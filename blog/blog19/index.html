<!doctype html><html>
<head>
<title>VEditorKit: Lightweight and Powerful Editor Kit (Part 1. NSTextStorage) // Geektree0101</title>
<meta charset=utf-8>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=description content="Lightweight and Powerful Editor Kit built on Texture">
<meta property="og:title" content="VEditorKit: Lightweight and Powerful Editor Kit (Part 1.  NSTextStorage)">
<meta property="og:description" content>
<meta property="og:type" content="website">
<meta property="og:locale" content="en">
<meta property="og:url" content="/blog/blog19/">
<link rel="shortcut icon" href=/favicon.ico>
<link href=/webfonts/ptserif/main.css rel=stylesheet type=text/css>
<link href=/webfonts/source-code-pro/main.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/article-toc.css type=text/css>
<meta name=generator content="Hugo 0.92.0">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3090955890879034" crossorigin=anonymous></script>
</head>
<body>
<div id=container>
<header id=header>
<div id=header-outer class=outer>
<div id=header-inner class=inner>
<a id=main-nav-toggle class=nav-icon href=javascript:;></a>
<a id=logo class=logo-text href=/>Geektree0101</a>
<nav id=main-nav>
<a class=main-nav-link href=/about>About</a>
<a class=main-nav-link href=/categories>Categories</a>
<a class=main-nav-link href=/tags>Tags</a>
</nav>
<nav id=sub-nav>
<div id=search-form-wrap>
</div>
</nav>
</div>
</div>
</header>
<section id=main class=outer>
<article class="article article-type-post" itemscope itemprop=blogPost>
<div class=article-inner>
<header class=article-header>
<h1 class=article-title itemprop=name>VEditorKit: Lightweight and Powerful Editor Kit (Part 1. NSTextStorage)</h1>
</header>
<div class=article-meta>
<a href=/blog/blog19/ class=article-date>
<time datetime=2019-01-20T04:23:30.385+00:00 itemprop=datePublished>2019-01-20</time>
</a>
<div class=post-categories>
<div class=article-category>
<a class=article-category-link href=/categories/ios>iOS</a>
</div>
</div>
<div class=article-comment-link-wrap>
<a href=/blog/blog19/#disqus_thread class=article-comment-link>Comments</a>
</div>
</div>
<div class=article-entry itemprop=articleBody>
<p><img src=/images/blog/0__SxvCIXdi445gUH7r.png alt></p>
<p>Lightweight and Powerful Editor Kit built on Texture(AsyncDisplayKit)</p>
<p>VEditorKit provides the <strong>most core functionality</strong> needed for the editor. Unfortunately, When <strong>combined words</strong> are entered then UITextView selectedRange will changed and <strong>typingAttribute will cleared</strong>. So, In combined words case, Users can’t continue typing the style they want.</p>
<p><a href=https://developer.apple.com/documentation/uikit/uitextview/1618629-typingattributes title=https://developer.apple.com/documentation/uikit/uitextview/1618629-typingattributes><strong>typingAttributes - UITextView | Apple Developer Documentation</strong><br>
_This dictionary contains the attribute keys (and corresponding values) to apply to newly typed text. When the text…_developer.apple.com</a><a href=https://developer.apple.com/documentation/uikit/uitextview/1618629-typingattributes></a></p>
<blockquote>
<p>This dictionary contains the attribute keys (and corresponding values) to apply to newly typed text. <strong>When the text view’s selection changes, the contents of the dictionary are cleared automatically</strong>.</p>
</blockquote>
<p><img src=/images/blog/0__Ci6__gbc8tjS1vW1R.jpg alt></p>
<h4 id=so-how-to-solve-thisissue>So, How to solve this issue?</h4>
<p>Key points is NSTextStorage!</p>
<p><a href=https://developer.apple.com/documentation/uikit/nstextstorage title=https://developer.apple.com/documentation/uikit/nstextstorage><strong>NSTextStorage - UIKit | Apple Developer Documentation</strong><br>
_A text storage object can be accessed from any thread of your app, but your app must guarantee access from only one…_developer.apple.com</a><a href=https://developer.apple.com/documentation/uikit/nstextstorage></a></p>
<p>Our Vingle iOS team is missing part is as follows :</p>
<ul>
<li>UITextView covers many attribute-related features such as delete, typing with bold, italic, heading, quote attributes</li>
<li>No dependency separation between typing attribute controller with UITextView</li>
<li>When the text view’s selection changes, the contents of the dictionary are cleared automatically. But, Our team UITextView apply typing attribute value on a redundant basis after update text.</li>
</ul>
<p><a href=https://github.com/GeekTree0101/VEditorKit/blob/master/VEditorKit/Classes/VEditorTextStorage.swift title=https://github.com/GeekTree0101/VEditorKit/blob/master/VEditorKit/Classes/VEditorTextStorage.swift><strong>GeekTree0101/VEditorKit</strong><br>
_Lightweight and Powerful Editor Kit (Beta). Contribute to GeekTree0101/VEditorKit development by creating an account on…_github.com</a><a href=https://github.com/GeekTree0101/VEditorKit/blob/master/VEditorKit/Classes/VEditorTextStorage.swift></a></p>
<p>The above problems were resolved as follows.</p>
<h3 id=1-define-typing-status--make-currenttypingattribute-property>1. Define typing status & make currentTypingAttribute property</h3>
<p>enum TypingStstus { <br>
case typing <br>
case remove <br>
case paste <br>
case none <br>
}</p>
<p>internal var currentTypingAttribute: [NSAttributedString.Key: Any] = [:]</p>
<p>currentTypingAttribute replaces UITextView typingAttribute property.</p>
<p>In this case, How to update internal currentTypingAttribute on NSTextStorage?.</p>
<p>The solutions are as follows:</p>
<p>open class VEditorTextNode: ASEditableTextNode, ASEditableTextNodeDelegate {</p>
<pre><code>open var textStorage: VEditorTextStorage? {   
   return self.textView.textStorage as? VEditorTextStorage      
 }     
  
open var currentTypingAttribute: \[NSAttributedString.Key: Any\] = \[:\] {          
 didSet {  
       self.typingAttributes = currentTypingAttribute  
                               .typingAttribute()  
       self.textStorage?  
           .currentTypingAttribute = currentTypingAttribute  
 }     
</code></pre>
<p>}</p>
<p>If you set currentTypingAttribute on TextView then automatically update UITextView typingAttribute with textStorage internal currentTypingAttribute.</p>
<h3 id=2-set-typingstatus-as-paste-on-setattributedstring>2. Set typingStatus as Paste on setAttributedString:</h3>
<p>override public func setAttributedString(_ attrString: NSAttributedString) { <br>
self.status = .paste <br>
super.setAttributedString(attrString) <br>
}</p>
<h3 id=3-set-typingstatus-as-remove-or-typing-on-replacecharacters>3. Set typingStatus as remove or typing on replaceCharacters:</h3>
<p>override public func replaceCharacters(in range: NSRange, with str: String) { <br>
if self.status != .paste { <br>
self.status = str.isEmpty ? .remove: .typing <br>
}</p>
<pre><code>self.beginEditing()         
self.internalAttributedString  
    .replaceCharacters(in: range, with: str)          
self.replaceTextString(in: range, with: str)       
self.edited(.editedCharacters,  
            range: range,  
            changeInLength: str.count - range.length)          
self.endEditing()     
</code></pre>
<p>}</p>
<p>If status is paste then ignore status updating as remove or typing.</p>
<p>override public func setAttributes(_ attrs: [NSAttributedString.Key: Any]?, range: NSRange) {</p>
<pre><code> guard internalAttributedString.length &gt; range.location else {   
      return   
 }           
     
 switch status {        
   case .typing, .paste: break      
   default: return          
 }         
      
 self.beginEditing()  
 self.internalAttributedString  
     .setAttributes(attrs, range: range)  
 self.edited(.editedAttributes, range: range, changeInLength: 0)  
 self.endEditing()      
</code></pre>
<p>}</p>
<p>In typing & paste status, after typing text will operate setAttributes methods.</p>
<h3 id=4-override-processediting>4. override processEditing:</h3>
<p>override public func processEditing() {<br>
switch status {<br>
case .typing: <br>
guard !self.currentTypingAttribute.isEmpty else { break }<br>
self.internalAttributedString<br>
.setAttributes(self.currentTypingAttribute,<br>
range: self.editedRange) <br>
default: <br>
break <br>
}<br>
super.processEditing() <br>
}</p>
<p>In combined character typing status, typingAttribute cleared due to selection changing. But, currentTypingAttribute sustained and will set expected typing attributes. Therefore, The cleared UITextView typingAttribute returns internal currentTypingAttribute on NSTextStorage by UITextView internal system logic.</p>
<p><img src=/images/blog/1__GPJAsVw4I3XUyPsDEejF9w.gif alt>
<img src=/images/blog/1__ewpzNsWOxjOW8AADYYr3pg.gif alt></p>
<p><img src=/images/blog/1__6HbBYrl6A4WEKAa8Wh6diQ.png alt></p>
<p>VEditorKit is looking for contributor who will be thinking about iOS Text editor technology.</p>
<p><img src=/images/blog/1__GPJAsVw4I3XUyPsDEejF9w.gif alt>
<img src=/images/blog/1__ewpzNsWOxjOW8AADYYr3pg.gif alt>
<img src=/images/blog/1__PRjX2mIls8nOIfx2hRavNg.gif alt></p>
<p><img src=/images/blog/1__faTeUe8mKcnq9Z8ltt__zUA.gif alt>
<img src=/images/blog/1__9ytvYQ__cRnh7P7FJYxKoYQ.gif alt>
<img src=/images/blog/1__rRnf__vMUta7SUS__7hH2nmw.gif alt></p>
</div>
<div class=article-toc>
<h3>Contents</h3>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li></li>
<li><a href=#1-define-typing-status--make-currenttypingattribute-property>1. Define typing status & make currentTypingAttribute property</a></li>
<li><a href=#2-set-typingstatus-as-paste-on-setattributedstring>2. Set typingStatus as Paste on setAttributedString:</a></li>
<li><a href=#3-set-typingstatus-as-remove-or-typing-on-replacecharacters>3. Set typingStatus as remove or typing on replaceCharacters:</a></li>
<li><a href=#4-override-processediting>4. override processEditing:</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<footer class=article-footer>
<ul class=article-tag-list>
<li class=article-tag-list-item>
<a class=article-tag-list-link href=tags/ios>ios
</a>
</li>
<li class=article-tag-list-item>
<a class=article-tag-list-link href=tags/vingle>vingle
</a>
</li>
<li class=article-tag-list-item>
<a class=article-tag-list-link href=tags/veditorkit>VEditorKit
</a>
</li>
</ul>
</footer>
</div>
<nav id=article-nav>
<a href=/blog/blog18/ id=article-nav-newer class=article-nav-link-wrap>
<div class=article-nav-title><span>&lt;</span>&nbsp;
Vingle Texture Style guide
</div>
</a>
<a href=/blog/2018-12-23_hello-bazel-db5d237e204c/ id=article-nav-older class=article-nav-link-wrap>
<div class=article-nav-title>Hello Bazel!&nbsp;<span>></span></div>
</a>
</nav>
</article>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//https-geektree0101-github-io.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</section>
<footer id=footer>
<div class=outer>
<div id=footer-info class=inner>
&copy; 2022 Geektree0101
<br>
Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos target=_blank>Minos</a>
</div>
</div>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script>
<script>hljs.initHighlightingOnLoad()</script>
<script>document.getElementById('main-nav-toggle').addEventListener('click',function(){var a=document.getElementById('header');a.classList.contains('mobile-on')?a.classList.remove('mobile-on'):a.classList.add('mobile-on')})</script>
</footer>
</div>
</body>
</html>