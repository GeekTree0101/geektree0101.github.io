<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<title>How to pre-append ASCellNode like a Chat Application</title>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name=description content="How to pre-append ASCellNode like a Chat Application?">
<meta name=author content="somrat">
<meta name=generator content="Hugo 0.88.1">
<link rel=preconnect href=https://fonts.gstatic.com>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/bootstrap/bootstrap.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,700,900&display=swap">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/hover/hover.css>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/magnific-popup/magnific-popup.css>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/owl-carousel/owl.carousel.min.css>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/owl-carousel/owl.theme.default.min.css>
<link rel=stylesheet href=https://geektree0101.github.io/plugins/text-animation/text-animation.css>
<link rel=stylesheet href=https://geektree0101.github.io/css/style.min.css media=screen>
<link rel=stylesheet href=https://geektree0101.github.io/css/custom.min.css media=screen>
<link rel="shortcut icon" href=https://geektree0101.github.io/images/favicon.png type=image/x-icon>
<link rel=icon href=https://geektree0101.github.io/images/favicon.png type=image/x-icon>
<meta property="og:image" content="https://geektree0101.github.io/images/blog/1__qAfL9DqKdLSzUVTTyhdXcg.gif">
<meta property="og:title" content="How to pre-append ASCellNode like a Chat Application">
<meta property="og:description" content="How to pre-append ASCellNode like a Chat Application?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://geektree0101.github.io/blog/2018-06-06_how-to-pre-append-ascellnode-like-a-chat-application-23b35d39b6cb/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2018-06-06T04:08:11+00:00">
<meta property="article:modified_time" content="2018-06-06T04:08:11+00:00">
</head><body>
<div class=preloader>
<img src=https://geektree0101.github.io/images/preloader.gif alt=preloader>
</div>
<section class="menu menu-fix" id=home>
<nav>
<div class="menu-container menu-normal">
<ul class="desktop-menu list-inline mb-0 justify-content-end" id=desktop-menu>
<li class="menu-item menu-item-transparent dark hvr-underline-from-left 1"><a href=https://geektree0101.github.io/>Home</a></li>
<li class="menu-item menu-item-transparent dark hvr-underline-from-left 1"><a href=https://geektree0101.github.io/#blog>Post</a></li>
<li class="menu-item menu-item-transparent dark hvr-underline-from-left 1"><a href=https://geektree0101.github.io/#about>About me</a></li>
</ul>
<div class=mobile-menu>
<a class=menu-link>
<div class=mobile-menu-nav>
<span></span>
<span></span>
<span></span>
</div>
</a>
<div class=menu-slider>
<nav>
<ul class=mobile-menu-list>
<li class="hvr-shutter-out-vertical mobile-menu-item 1"><a href=https://geektree0101.github.io/>Home</a></li>
<li class="hvr-shutter-out-vertical mobile-menu-item 1"><a href=https://geektree0101.github.io/#blog>Post</a></li>
<li class="hvr-shutter-out-vertical mobile-menu-item 1"><a href=https://geektree0101.github.io/#about>About me</a></li>
</ul>
<ul class="mobile-menu-icons list-inline">
<li><a href="https://www.facebook.com/profile.php?id=100009249402427"><i class="fab fa-facebook-f"></i></a></li>
<li><a href=https://github.com/Geektree0101><i class="fab fa-github"></i></a></li>
<li><a href=https://www.linkedin.com/in/hyeonsu-ha-7ba02b112/><i class="fab fa-linkedin"></i></a></li>
</ul>
</nav>
</div>
</div>
</div>
</nav>
</section>
<div style=height:50px></div>
<section class=section>
<div class=container>
<div class=row>
<div class="col-lg-8 mb-4 mb-lg-0">
<div class="wow fadeInUp" data-wow-duration=1.5s>
<img src=https://geektree0101.github.io/images/blog/1__qAfL9DqKdLSzUVTTyhdXcg.gif alt=image class="img-fluid w-100 mb-5">
<div class="about-me-text mb-4">
<h1>How to pre-append ASCellNode like a Chat Application</h1>
</div>
<div class=content><p><img src=/images/blog/1__qAfL9DqKdLSzUVTTyhdXcg.gif alt></p>
<h4 id=how-to-pre-append-ascellnode-like-a-chat-application>How to pre-append ASCellNode like a Chat Application?</h4>
<blockquote>
<p>Texture is an iOS framework built on top of UIKit that keeps even the most complex user interfaces smooth and responsive.</p>
</blockquote>
<p>8 months ago, our Vingle iOS team has been using it with RxSwift & RxCocoa.</p>
<p>About a month, Our team has been working on a realtime chat application project called “Vingle Talk” .</p>
<p>Well, Every iOS Developer & Texture Fan know that ASTableNode & ASCollectionNode doesn’t support Bi-Directional Pagination.</p>
<p><a href=https://github.com/TextureGroup/Texture/blob/master/Source/Private/ASBatchFetching.m title=https://github.com/TextureGroup/Texture/blob/master/Source/Private/ASBatchFetching.m><strong>TextureGroup/Texture</strong><br>
_Texture - Smooth asynchronous user interfaces for iOS apps._github.com</a><a href=https://github.com/TextureGroup/Texture/blob/master/Source/Private/ASBatchFetching.m></a></p>
<p>// If they are scrolling toward the head of content, don’t batch fetch.<br>
BOOL isScrollingTowardHead = (ASScrollDirectionContainsUp(scrollDirection) || ASScrollDirectionContainsLeft(scrollDirection)); if (isScrollingTowardHead) { return NO; }</p>
<p>ASBatchFetching just trigger only scroll up & left. (ASBatchFetching.m line 90)</p>
<p>So, We customized it which is able to bi-directional batch fetching on ASTableNode like this</p>
<p><img src=/images/blog/1__vWlMaI3WJW061O1jiac1Dw.png alt></p>
<p>At first, Save contentSize Height before ASTableNode pre-fetching.</p>
<p>let prevContentHeight = self.tableNode.view.contentSize.height</p>
<p>self.tableNode.performBatch(updates: { … }, complate: { … })</p>
<p>and then, Calculate contentSize height difference value between previous contentSize height with present contentSize height, and get content y-offset</p>
<p>self.tableNode.performBatch(updates: { … }, complate: { _ in<br>
let presentHeight = self.tableNode.view.contentSize.height<br>
let diff = presentHeight - prevContentHeight<br>
var offset = self.tableNode.contentOffset</p>
<p>})</p>
<p>In this case, you can see that contentOffset doesn’t change after update ASTableNode. So, you just append difference value onto content y-offset with setContentOffset</p>
<p>self.tableNode.performBatch(updates: { … }, complate: { _ in<br>
let presentHeight = self.tableNode.view.contentSize.height<br>
let diff = presentHeight - prevContentHeight<br>
var offset = self.tableNode.contentOffset<br>
offset.y += diff</p>
<pre><code>self.tableNode.setContentOffset(offset, animated: false)
</code></pre>
<p>})</p>
<h4 id=is-it-work-i-sayno>Is it work? I say NO!</h4>
<p>I found that ASTableNode <strong>contentSize is constantly changing</strong> after finished tableNode and during scrolling. Because, Chatting message is variable content which contain message text, media, open-graph or some emoji and so on. So I modified it as follows.</p>
<h4 id=modified-asfollows>Modified as follows</h4>
<ol>
<li>Replace ASTableNode to ASCollectionNode with using UICollectionViewFlowLayout</li>
<li>Revise pre-appending timing at content offset close to zero.</li>
<li>Avoid excessive use Reactive Functional Programming(RxSwift & RxCocoa) to update message content</li>
</ol>
<p>Replace ASTableNode to ASCollectionNode with using UICollectionViewFlowLayout</p>
<p>UICollectionViewFlowLayout offer powerful functions and you can trigger all of collection update process job.</p>
<p>At first, we don’t care append process job. Automatically, it will work on ASBatchFetching. so, we just consider on pre-appending process job.</p>
<p>I made very simply ChatFlowLayout base on ASCollectionNode. and process jobs arranged by code lines.</p>
<p>When ASCollectionNode begin pre-append items from index zero. ChatFlowLayout will work.</p>
<ol>
<li>layoutAttributesForElements(in:) line 11</li>
</ol>
<ul>
<li>Reset offset and scope(Append or Pre-Append Control Variable)</li>
</ul>
<p>2. prepare(forCollectionViewUpdates updateItems:) line 19</p>
<ul>
<li>1. Calculate Bottom and Top Visible Item Count</li>
<li>2. Checking Initial Load or Load More</li>
<li>3. Checking Pre-Append work or Append work</li>
<li>4. In Pre-Append Case, Calculate new items total height.</li>
<li>5. CATransaction begin with disable actions</li>
</ul>
<p>3. finalizeCollectionViewUpdates() line 81</p>
<ul>
<li>In Pre-Append Case, Adjust content offset</li>
</ul>
<p>Revise pre-appending timing at content offset close to zero.</p>
<p><img src=/images/blog/1__Cm3oXH__1zv4GBEOYLpnJWw.jpeg alt>
<img src=/images/blog/1__l5gn9lmjcAq7Ezqod3kANQ.jpeg alt></p>
<p>Well, You know these famous Chat Application. WeChat & Kakao Talk.</p>
<p>These has a common feature.</p>
<p>It is that These <strong>pre-append messages at content offset close to zero</strong>.</p>
<p>Before, I just customized ASBatchFetching that pre-append fetching can work like a basic append fetching work.</p>
<p>let contentSize: CGSize = scrollView.contentSize<br>
let viewLength = bounds.size.height<br>
let contentLength = contentSize.height</p>
<p>// has small content<br>
if contentLength &lt; viewLength {<br>
switch scrollDirection {<br>
case .down: return .prepend<br>
case .up: return .append<br>
default: return .none }<br>
}</p>
<p>let triggerDistance = viewLength * leadingScreens let remainingDistance = contentLength — viewLength — offset</p>
<p>switch scrollDirection {<br>
case .down:<br>
return remainingDistance &lt;= triggerDistance ?<br>
.append: .none<br>
case .up:<br>
return offset &lt; triggerDistance ? &#171;&mdash; @HERE<br>
.prepend: .none<br>
default:<br>
return .none<br>
}</p>
<p>But This logic occur unnatural update collection items pre-appending work with unexpected content offset.</p>
<p>So, i just adjust pre-append trigger offset.</p>
<p>switch scrollDirection {<br>
case .down:<br>
return remainingDistance &lt;= triggerDistance ?<br>
.append: .none<br>
case .up:<br>
guard offset &lt;= 0.0 else { return .none } &#171;&mdash; @HERE<br>
return .prepend<br>
default:<br>
return .none<br>
}</p>
<p>Avoid excessive use Reactive Functional Programming(RxSwift & RxCocoa) to update message content</p>
<p><img src=/images/blog/1__c4KOXac7Nyl1m____0cVzJ9w.png alt></p>
<p>VTalk(Vingle Talk) message contains some simple components such as media, profile, message text, like engage button, username, timestamp and so on.</p>
<p>Especially, media should calculate image-ratio base on max/minimum width & height.</p>
<p>Unfortunately, all of message components are updated by component attribute observer on <a href=https://medium.com/@h2s1880/texture-best-practice-5-8958482e7fb3>ViewModel</a></p>
<p>So, <a href=http://texturegroup.org/docs/intelligent-preloading.html>Before entering display status</a>, Sometime layoutAttributesForItem method return unexpected attributes on UICollectionFlowLayout prepare method.</p>
<p>Because, media is asynchronously updated by observer on ViewModel. Finally, layoutAttributesForItem don’t know that message contain media with height value base on image ratio.</p>
<p>If sent message don’t need revise, i recommend avoid reactive programming at here. If you need update message content then just reload cell.</p>
</div>
<div class="tags mt-4 content">
<i class="fas fa-tags mr-2"></i>
<a href=https://geektree0101.github.io/tags/ios>Ios</a>, <a href=https://geektree0101.github.io/tags/chat>Chat</a>
</div>
</div>
</div>
</div>
</div>
</section>
<footer class="footer-bg fadeInUp wow" data-wow-duration=1.5s>
<div class=container>
<div class=row>
<div class="footer col-lg-10 offset-lg-1">
<hr>
<ul class="footer-icons list-inline">
<li><a href="https://www.facebook.com/profile.php?id=100009249402427"><i class="fab fa-facebook-f"></i></a></li>
<li><a href=https://github.com/Geektree0101><i class="fab fa-github"></i></a></li>
<li><a href=https://www.linkedin.com/in/hyeonsu-ha-7ba02b112/><i class="fab fa-linkedin"></i></a></li>
</ul>
<div class=to-top>
<a href=#home><i class="fa fa-chevron-up"></i></a>
</div>
<div class="credit content">
Copyright © 2021 a hugo theme by <a href=https://somrat.netlify.com>somrat</a>
</div>
</div>
</div>
</div>
</footer>
<script src=https://geektree0101.github.io/plugins/jQuery/jquery.min.js></script>
<script src=https://geektree0101.github.io/plugins/bootstrap/bootstrap.min.js></script>
<script src=https://geektree0101.github.io/plugins/wow.min.js></script>
<script src=https://geektree0101.github.io/plugins/text-animation/text-animation.js></script>
<script src=https://geektree0101.github.io/plugins/jquery.waypoints.min.js></script>
<script src=https://geektree0101.github.io/plugins/shuffle/shuffle.min.js></script>
<script src=https://geektree0101.github.io/plugins/magnific-popup/jquery.magnific-popup.min.js></script>
<script src=https://geektree0101.github.io/plugins/owl-carousel/owl.carousel.min.js></script>
<script src=https://geektree0101.github.io/js/script.min.js></script>
</body>
</html>